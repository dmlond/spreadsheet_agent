<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: SpreadsheetAgent::Agent</title>

  <link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

  <script src="../js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="../lib/spreadsheet_agent_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="lib/spreadsheet_agent.rb">lib/spreadsheet_agent.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link"><a href="Db.html">SpreadsheetAgent::Db</a></p>
        
      </div>
      

      

      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-new">::new</a></li>
          
          <li><a href="#method-i-get_entry">#get_entry</a></li>
          
          <li><a href="#method-i-process-21">#process!</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../LICENSE.html">LICENSE</a></li>
        
          <li class="file"><a href="../Rakefile.html">Rakefile</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../SpreadsheetAgent.html">SpreadsheetAgent</a></li>
        
          <li><a href="../SpreadsheetAgent/Agent.html">SpreadsheetAgent::Agent</a></li>
        
          <li><a href="../SpreadsheetAgent/Db.html">SpreadsheetAgent::Db</a></li>
        
          <li><a href="../SpreadsheetAgent/Error.html">SpreadsheetAgent::Error</a></li>
        
          <li><a href="../SpreadsheetAgent/Runner.html">SpreadsheetAgent::Runner</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">SpreadsheetAgent::Agent</h1>

    <div id="description" class="description">
      
<p><a href="Agent.html">SpreadsheetAgent::Agent</a> is designed to make it
easy to create a single task which connects to a field within a record on a
page within the configured <a
href="../SpreadsheetAgent.html">SpreadsheetAgent</a> compatible Google
Spreadsheet, runs, and reports whether the job completed or ended in error.
An agent can be configured to only run when certain prerequisite fields
have completed.  The data in these fields can be filled in by other
SpreadsheetAgent::Agents, SpreadsheetAgent::Runners, or humans.  Compute
node configuration is available to prevent the agent from running more than
a certain number of instances of itself, or not run if certain other agents
or processes are running on the node.  Finally, an agent can be configured
to subsume another agent, and fill in the completion field for that agent
in addition to its own when it completes successfully.</p>

<p>extends <a href="Db.html">SpreadsheetAgent::Db</a></p>

    </div><!-- description -->

    
    
    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      

      
      <!-- Attributes -->
      <div id="attribute-method-details" class="method-section section">
        <h3 class="section-header">Attributes</h3>

        
        <div id="agent_name-attribute-method" class="method-detail">
          <a name="agent_name"></a>
          
          <a name="agent_name="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">agent_name</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>The name of the field in the page to which the agent should report status</p>
          
          </div>
        </div>
        
        <div id="conflicts_with-attribute-method" class="method-detail">
          <a name="conflicts_with"></a>
          
          <a name="conflicts_with="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">conflicts_with</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>Hash of process_name to number of max_instances.  This works on Linux with
ps.  If the agent detects the specified number of max_instances of the
given process (based on a line match), it will not attempt to run</p>
          
          </div>
        </div>
        
        <div id="debug-attribute-method" class="method-detail">
          <a name="debug"></a>
          
          <a name="debug="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">debug</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>Boolean. When true, the agent code will print verbosely to STDERR.  When
false, and the process! returns a failure status, the agent will email all
stdout and stderr to the email specified in the :config send_to value</p>
          
          </div>
        </div>
        
        <div id="keys-attribute-method" class="method-detail">
          <a name="keys"></a>
          
          <a name="keys="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">keys</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>hash of key-value pairs.  The keys are defined in config/agent.conf.yml. 
The values specify the values for those fields in the record on the page
for which the agent is running. All keys configured as ‘required: 1’ in
config/agent.conf.yml must be included in the keys hash</p>
          
          </div>
        </div>
        
        <div id="max_selves-attribute-method" class="method-detail">
          <a name="max_selves"></a>
          
          <a name="max_selves="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">max_selves</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>Optional integer.  This works on Linux with ps.  The agent will not attempt
to run if there are <a
href="Agent.html#attribute-i-max_selves">max_selves</a> instances running</p>
          
          </div>
        </div>
        
        <div id="page_name-attribute-method" class="method-detail">
          <a name="page_name"></a>
          
          <a name="page_name="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">page_name</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>The name of the Page on the Google Spreadsheet that contains the record to
be worked on by the agent</p>
          
          </div>
        </div>
        
        <div id="prerequisites-attribute-method" class="method-detail">
          <a name="prerequisites"></a>
          
          <a name="prerequisites="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">prerequisites</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>Optional array of prerequisite fields that must contain a 1 in them for the
record on the page before the agent will attempt to run</p>
          
          </div>
        </div>
        
        <div id="subsumes-attribute-method" class="method-detail">
          <a name="subsumes"></a>
          
          <a name="subsumes="></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">subsumes</span><span
              class="attribute-access-type">[RW]</span>
          </div>

          <div class="method-description">
          
          <p>Array of fields on the record which this agent subsumes.  If the agent
completes successfully these fields will be updated with a 1 in addition to
the field for the agent</p>
          
          </div>
        </div>
        
        <div id="worksheet-attribute-method" class="method-detail">
          <a name="worksheet"></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">worksheet</span><span
              class="attribute-access-type">[R]</span>
          </div>

          <div class="method-description">
          
          <p>Readonly access to the GoogleDrive::Worksheet that is being access by the
agent.</p>
          
          </div>
        </div>
        
      </div><!-- attribute-method-details -->
      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="new-method" class="method-detail ">
          <a name="method-c-new"></a>

          
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(attributes)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>create a new <a href="Agent.html">SpreadsheetAgent::Agent</a> with the
following:</p>

<h2>required configuration parameters:</h2>
<ul><li>
<p><a href="Agent.html#attribute-i-agent_name">agent_name</a></p>
</li><li>
<p><a href="Agent.html#attribute-i-page_name">page_name</a></p>
</li><li>
<p>keys</p>
</li></ul>

<h2>optional parameters:</h2>
<ul><li>
<p>config_file: (see SpreadsheetAgent::DB)</p>
</li><li>
<p>debug</p>
</li><li>
<p>prerequisites</p>
</li><li>
<p><a href="Agent.html#attribute-i-max_selves">max_selves</a></p>
</li><li>
<p><a href="Agent.html#attribute-i-conflicts_with">conflicts_with</a></p>
</li><li>
<p>subsumes</p>
</li></ul>
            

            
            <div class="method-source-code" id="new-source">
<pre>
<span class="ruby-comment"># File lib/spreadsheet_agent.rb, line 97</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-ivar">@agent_name</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:agent_name</span>]
  <span class="ruby-ivar">@page_name</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:page_name</span>]
  <span class="ruby-ivar">@keys</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:keys</span>].<span class="ruby-identifier">clone</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@agent_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@page_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@keys</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SpreadsheetAgentError</span>, <span class="ruby-string">&quot;agent_name, page_name, and keys attributes are required!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@config_file</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:config_file</span>]
  <span class="ruby-identifier">build_db</span>()

  <span class="ruby-ivar">@worksheet</span> = <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">worksheet_by_title</span>(<span class="ruby-ivar">@page_name</span>)
  <span class="ruby-ivar">@debug</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:debug</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:prerequisites</span>]
    <span class="ruby-ivar">@prerequisites</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:prerequisites</span>].<span class="ruby-identifier">clone</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@max_selves</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:max_selves</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:conflicts_with</span>]
    <span class="ruby-ivar">@conflicts_with</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:conflicts_with</span>].<span class="ruby-identifier">clone</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:subsumes</span>]
    <span class="ruby-ivar">@subsumes</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:subsumes</span>].<span class="ruby-identifier">clone</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- new-source -->
            
          </div>

          

          
        </div><!-- new-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="get_entry-method" class="method-detail ">
          <a name="method-i-get_entry"></a>

          
          <div class="method-heading">
            <span class="method-name">get_entry</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Returns the GoogleDrive::List object for the specified keys</p>
            

            
            <div class="method-source-code" id="get_entry-source">
<pre>
<span class="ruby-comment"># File lib/spreadsheet_agent.rb, line 199</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_entry</span>
  <span class="ruby-identifier">this_entry</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@worksheet</span>
    <span class="ruby-ivar">@worksheet</span>.<span class="ruby-identifier">list</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">this_row</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">keep_row</span> = <span class="ruby-keyword">true</span>

      <span class="ruby-ivar">@config</span>[<span class="ruby-string">'key_fields'</span>].<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key_field</span><span class="ruby-operator">|</span>
        <span class="ruby-operator">!</span>(<span class="ruby-ivar">@config</span>[<span class="ruby-string">'key_fields'</span>][<span class="ruby-identifier">key_field</span>][<span class="ruby-string">&quot;required&quot;</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-ivar">@keys</span>[<span class="ruby-identifier">key_field</span>])
      }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">keep_row</span>
        <span class="ruby-identifier">keep_row</span> = (<span class="ruby-identifier">this_row</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">==</span> <span class="ruby-ivar">@keys</span>[<span class="ruby-identifier">key</span>])
      <span class="ruby-keyword">end</span>
    
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">keep_row</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">this_row</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- get_entry-source -->
            
          </div>

          

          
        </div><!-- get_entry-method -->

      
        <div id="process-21-method" class="method-detail ">
          <a name="method-i-process-21"></a>

          
          <div class="method-heading">
            <span class="method-name">process!</span><span
              class="method-args">(&agent_code)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>If the agent does not have any conflicting processes (<a
href="Agent.html#attribute-i-max_selves">max_selves</a> or <a
href="Agent.html#attribute-i-conflicts_with">conflicts_with</a>) and if the
entry is ready (field ‘ready’ has a 1), and all prerequisite fields have a
1, gets the GoogleDrive::List record, and passes it to the supplied
agent_code PROC as argument. This PROC must return a required boolean field
indicating success or failure, and an optional hash of key - value fields
that will be updated on the GoogleDrive::List record.  Note, the updates
are made regardless of the value of success.  In fact, the agent can be
configured to update different fields based on success or failure.   Also,
note that any value can be stored in the hash.  This allows the agent to
communicate any useful information to the google spreadsheet for other
agents (<a href="Agent.html">SpreadsheetAgent::Agent</a>, <a
href="Runner.html">SpreadsheetAgent::Runner</a>, or human) to use. The PROC
must try at all costs to avoid terminating. If an error is encountered, it
should return false for the success field to signal that the process
failed.  If no errors are encountered it should return true for the success
field.</p>

<pre>Exits successfully, enters a 1 in the agent_name field
$agent-&gt;process! do |entry|
  true
end

Same, but also updates the 'notice' field in the record along with the 1 in the agent_name field
$agent-&gt;process! do |entry|
  [true, {:notice =&gt; 'There were 30 files processed'}]
end

Fails, enters f:#{hostname} in the agent_name field
$agent-&gt;process! do |entry|
  false

Same, but also updates the 'notice' field in the record along with the failure notice
$agent-&gt;process! do |entry|
  [false, {:notice =&gt; 'There were 10 files left to process!' }]
end

This agent passes different parameters based on success or failure
$agent-&gt;process! do |entry|
  if $success
    true
  else
    [ false, {:notice =&gt; 'there were 10 remaining files'}]
  end
end</pre>
            

            
            <div class="method-source-code" id="process-21-source">
<pre>
<span class="ruby-comment"># File lib/spreadsheet_agent.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">process!</span>(&amp;<span class="ruby-identifier">agent_code</span>)
  <span class="ruby-ivar">@worksheet</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-identifier">no_problems</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">capture_output</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@debug</span>
    <span class="ruby-identifier">capture_output</span> = <span class="ruby-constant">CaptureIO</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">capture_output</span>.<span class="ruby-identifier">start</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_conflicts</span>()
    (<span class="ruby-identifier">runnable</span>, <span class="ruby-identifier">entry</span>) = <span class="ruby-identifier">run_entry</span>()
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">entry</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">runnable</span>
  
    <span class="ruby-identifier">success</span>, <span class="ruby-identifier">update_entry</span> = <span class="ruby-identifier">agent_code</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">entry</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">success</span>
      <span class="ruby-identifier">complete_entry</span>(<span class="ruby-identifier">update_entry</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">fail_entry</span>(<span class="ruby-identifier">update_entry</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{ $! }&quot;</span>
    <span class="ruby-identifier">no_problems</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">capture_output</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">no_problems</span>
      <span class="ruby-identifier">capture_output</span>.<span class="ruby-identifier">stop</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">mail_error</span>(<span class="ruby-identifier">capture_output</span>.<span class="ruby-identifier">stop</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">no_problems</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- process-21-source -->
            
          </div>

          

          
        </div><!-- process-21-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

